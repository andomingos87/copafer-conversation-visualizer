<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copafer - Visualizador de Conversas</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <!-- Flatpickr para date picker brasileiro -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-brand">
        <!-- Menu Hamb√∫rguer (mobile) -->
        <button id="menuToggle" class="menu-toggle" aria-label="Abrir menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="logo">
          <img src="assets/images/logo.webp" alt="Copafer" class="logo-img">
        </div>
        <span class="header-subtitle">Visualizador de Conversas</span>
      </div>
      <div class="header-search">
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
          <input type="text" id="searchInput" placeholder="Buscar por produto ou texto...">
          <button id="clearSearch" class="clear-btn" title="Limpar busca">√ó</button>
        </div>
      </div>
      <div class="header-actions">
        <!-- Menu Links √öteis -->
        <div class="links-menu-wrapper">
          <button id="linksMenuToggle" class="links-menu-btn" title="Links √∫teis">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
            </svg>
            <span class="links-menu-btn-text">Links</span>
          </button>
          <div id="linksMenuDropdown" class="links-menu-dropdown">
            <a href="https://proxy-cuboai.fly.dev/copafer-controle/carrinhos" target="_blank" class="links-menu-item">
              <span class="link-icon">üõí</span>
              <span>Carrinhos</span>
            </a>
            <a href="https://proxy-cuboai.fly.dev/erp/pagarme-webhooks" target="_blank" class="links-menu-item">
              <span class="link-icon">üîó</span>
              <span>Webhooks</span>
            </a>
            <a href="https://proxy-cuboai.fly.dev/erp" target="_blank" class="links-menu-item">
              <span class="link-icon">üì¶</span>
              <span>Incluir Pedido ERP</span>
            </a>
          </div>
        </div>
        
        <!-- Bot√£o Imagem Existe -->
        <button id="imagemExisteBtn" class="links-menu-btn" title="Verificar se imagem existe">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          <span class="links-menu-btn-text">Imagem existe?</span>
        </button>
        
        <div class="export-wrapper">
          <button id="exportAllBtn" class="export-btn" title="Exportar todas as conversas">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span class="export-btn-text">Exportar</span>
          </button>
          <div id="exportAllDropdown" class="export-dropdown">
            <button data-format="json">
              <span class="format-icon">{ }</span>
              JSON
            </button>
            <button data-format="txt">
              <span class="format-icon">üìÑ</span>
              TXT
            </button>
            <button data-format="csv">
              <span class="format-icon">üìä</span>
              CSV
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Overlay da Sidebar (mobile) -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Sidebar -->
      <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <button id="sidebarClose" class="sidebar-close" aria-label="Fechar menu">√ó</button>
          <h2>Conversas</h2>
          <span id="conversationCount" class="badge">0</span>
        </div>
        
        <div class="filter-section">
          <label for="clientFilter">Filtrar por cliente:</label>
          <div class="autocomplete-wrapper">
            <input 
              type="text" 
              id="clientFilter" 
              placeholder="Digite o n√∫mero ou selecione..."
              autocomplete="off"
            >
            <div id="clientFilterDropdown" class="autocomplete-dropdown"></div>
            <button id="clientFilterClear" class="autocomplete-clear" title="Limpar filtro" style="display: none;">√ó</button>
          </div>
        </div>

        <!-- Filtro por Data - Dropdown Compacto -->
        <div class="filter-section filter-section-date">
          <label>Filtrar por data:</label>
          <div class="date-filter-dropdown-wrapper">
            <!-- Bot√£o do Dropdown -->
            <button id="dateFilterToggle" class="date-filter-toggle">
              <span class="date-filter-icon">üìÖ</span>
              <span id="dateFilterLabel" class="date-filter-label">Selecione o per√≠odo...</span>
              <svg class="date-filter-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>

            <!-- Dropdown Content -->
            <div id="dateFilterDropdown" class="date-filter-dropdown">
              <!-- Op√ß√µes de per√≠odo em badges -->
              <div class="date-dropdown-section">
                <div class="date-badges">
                  <button class="date-badge" data-period="today">Hoje</button>
                  <button class="date-badge" data-period="yesterday">Ontem</button>
                  <button class="date-badge" data-period="last7days">7 dias</button>
                  <button class="date-badge" data-period="last30days">30 dias</button>
                  <button class="date-badge" data-period="thisMonth">M√™s</button>
                </div>
              </div>

              <!-- Per√≠odo personalizado + Crit√©rio em linha -->
              <div class="date-dropdown-section date-compact-row">
                <div class="date-custom-inline">
                  <input type="text" id="dateFrom" class="date-input-mini" placeholder="dd/mm/aaaa" title="Data inicial" readonly>
                  <span class="date-separator">a</span>
                  <input type="text" id="dateTo" class="date-input-mini" placeholder="dd/mm/aaaa" title="Data final" readonly>
                </div>
                <select id="dateCriteriaSelect" class="date-criteria-mini" title="Crit√©rio de filtro">
                  <option value="last" selected>√öltima msg</option>
                  <option value="first">Primeira msg</option>
                  <option value="any">Qualquer msg</option>
                </select>
              </div>

              <!-- Bot√£o Limpar compacto -->
              <button id="dateFilterClear" class="date-clear-inline">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Limpar
              </button>
            </div>
          </div>
        </div>

        <div id="conversationList" class="conversation-list">
          <!-- Lista de conversas ser√° renderizada aqui -->
        </div>
      </aside>

      <!-- Chat Area -->
      <section class="chat-area">
        <div id="chatHeader" class="chat-header">
          <div class="chat-header-info">
            <span class="chat-header-icon">üí¨</span>
            <span id="chatTitle">Selecione uma conversa</span>
          </div>
          <div class="chat-header-actions">
            <span id="messageCount" class="message-count"></span>
            <button id="feedbackBtn" class="feedback-btn-header" title="Adicionar feedback" style="display: none;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </button>
            <div id="exportCurrentWrapper" class="export-wrapper" style="display: none;">
              <button id="exportCurrentBtn" class="export-btn export-btn-small" title="Exportar esta conversa">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <div id="exportCurrentDropdown" class="export-dropdown">
                <button data-format="json">
                  <span class="format-icon">{ }</span>
                  JSON
                </button>
                <button data-format="txt">
                  <span class="format-icon">üìÑ</span>
                  TXT
                </button>
                <button data-format="csv">
                  <span class="format-icon">üìä</span>
                  CSV
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="chatMessages" class="chat-messages">
          <div class="empty-state">
            <div class="empty-icon">üì±</div>
            <p>Selecione uma conversa na lista ao lado para visualizar as mensagens</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Loading State -->
    <div id="loadingState" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Carregando conversas...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-overlay" style="display: none;">
      <div class="error-message">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Erro ao carregar conversas</h3>
        <p id="errorText">N√£o foi poss√≠vel conectar com a API. Verifique sua conex√£o e tente novamente.</p>
        <div class="error-actions">
          <button id="retryButton" class="btn-retry">Tentar novamente</button>
          <button id="useMockupButton" class="btn-mockup">Usar dados de exemplo</button>
        </div>
      </div>
    </div>
      </section>
    </main>
  </div>

  <!-- Modal Imagem Existe -->
  <div id="imagemExisteOverlay" class="imagem-existe-overlay" style="display: none;">
    <div id="imagemExisteModal" class="imagem-existe-modal">
      <div class="imagem-existe-modal-header">
        <h2>Imagem existe?</h2>
        <button id="imagemExisteCloseBtn" class="imagem-existe-close-btn" aria-label="Fechar">√ó</button>
      </div>
      
      <div class="imagem-existe-modal-body">
        <div class="imagem-existe-input-wrapper">
          <label for="imagemExisteInput" class="imagem-existe-label">C√≥digo do Produto</label>
          <div class="imagem-existe-input-group">
            <input 
              type="text" 
              id="imagemExisteInput" 
              class="imagem-existe-input"
              placeholder="Digite o c√≥digo do produto..."
              autocomplete="off"
            >
            <button id="imagemExisteBuscarBtn" class="imagem-existe-buscar-btn">
              <span class="buscar-text">Buscar</span>
              <div class="buscar-spinner" style="display: none;">
                <div class="spinner-small"></div>
              </div>
            </button>
          </div>
        </div>
        
        <div id="imagemExisteResultado" class="imagem-existe-resultado" style="display: none;">
          <div class="resultado-icon"></div>
          <span class="resultado-texto"></span>
        </div>
      </div>
      
      <div class="imagem-existe-modal-footer">
        <button id="imagemExisteFechaBtn" class="imagem-existe-fechar-btn">Fechar</button>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/data.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/feedback-api.js"></script>
  <script src="js/feedback.js"></script>
  <script src="js/imagem-existe.js"></script>
  <!-- Flatpickr para date picker brasileiro -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script>
    // Garante que o locale portugu√™s est√° dispon√≠vel antes de inicializar
    if (typeof flatpickr !== 'undefined' && flatpickr.l10ns) {
      // O locale pt j√° deve estar carregado pelo script acima
      console.log('Flatpickr locale pt carregado');
    }
  </script>
  <script src="js/app.js"></script>
</body>
</html>

